<div id="pc-widget-customizer" class="not-prose hx:flex hx:flex-col hx:gap-4 hx:mt-6">
    <div class="hx:flex hx:flex-col hx:gap-1 hx:md:flex-row hx:md:items-center hx:md:justify-between">
        <label class="hx:text-sm hx:font-medium" for="pc-widget-theme">Theme</label>
        <select id="pc-widget-theme" data-widget-option class="hx:w-full hx:md:w-64">
            <option value="light" selected>Light</option>
            <option value="dark">Dark</option>
        </select>
    </div>
    <div class="hx:flex hx:flex-col hx:gap-1 hx:md:flex-row hx:md:items-center hx:md:justify-between">
        <label class="hx:text-sm hx:font-medium" for="pc-widget-display-mode">Display mode</label>
        <select id="pc-widget-display-mode" data-widget-option class="hx:w-full hx:md:w-64">
            <option value="widget" selected>Widget</option>
            <option value="popup">Popup</option>
            <option value="hidden">Hidden</option>
        </select>
    </div>
    <div class="hx:flex hx:flex-col hx:gap-1 hx:md:flex-row hx:md:items-center hx:md:justify-between">
        <label class="hx:text-sm hx:font-medium" for="pc-widget-start-mode">Start mode</label>
        <select id="pc-widget-start-mode" data-widget-option class="hx:w-full hx:md:w-64">
            <option value="auto" selected>Auto</option>
            <option value="click">Click</option>
        </select>
    </div>
    <div class="hx:flex hx:flex-col hx:gap-1 hx:md:flex-row hx:md:items-center hx:md:justify-between">
        <label class="hx:text-sm hx:font-medium" for="pc-widget-lang">Language</label>
        <select id="pc-widget-lang" data-widget-option class="hx:w-full hx:md:w-64">
            <option value="auto" selected>Auto</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="es">Español</option>
            <option value="fr">Français</option>
        </select>
    </div>
    <div class="hx:flex hx:flex-col hx:gap-1 hx:md:flex-row hx:md:items-center hx:md:justify-between">
        <label class="hx:text-sm hx:font-medium" for="pc-widget-debug">Debug mode</label>
        <input id="pc-widget-debug" data-widget-option type="checkbox" class="hx:md:w-64">
    </div>
    <div class="hx:flex hx:flex-col hx:gap-1 hx:md:flex-row hx:md:items-center hx:md:justify-between">
        <label class="hx:text-sm hx:font-medium" for="pc-widget-eu">EU isolation</label>
        <input id="pc-widget-eu" data-widget-option type="checkbox" class="hx:md:w-64">
    </div>
</div>
<script>
    (() => {
        const customizerId = 'pc-widget-customizer';
        const widgetPreviewId = 'pc-widget-preview';
        const codeElementId = 'pc-widget-code';
        const copyButtonId = 'pc-widget-copy';
        const triggerButtonId = 'pc-widget-trigger';
        const sitekey = 'aaaaaaaabbbbccccddddeeeeeeeeeeee';
        const puzzleEndpoint = 'https://api.{{ .Site.Params.privateCaptchaDomain }}/puzzle';
        const scriptUrl = 'https://cdn.{{ .Site.Params.privateCaptchaDomain }}/widget/js/privatecaptcha.js?render=explicit';
        const snippetElementId = 'pc-widget';
        const triggerModes = new Set(['popup', 'hidden']);
        const pollIntervalMs = 250;
        const maxPollAttempts = 40;
        let pollAttempts = 0;
        let currentWidget = null;
        let latestOptions = null;

        const getOptionValue = (id) => {
            const element = document.getElementById(id);
            return element ? element.value : '';
        };

        const getOptionChecked = (id) => {
            const element = document.getElementById(id);
            return element ? element.checked : false;
        };

        const buildOptions = () => {
            const options = {
                sitekey,
                puzzleEndpoint,
                theme: getOptionValue('pc-widget-theme'),
                displayMode: getOptionValue('pc-widget-display-mode'),
                startMode: getOptionValue('pc-widget-start-mode')
            };

            const lang = getOptionValue('pc-widget-lang');
            if (lang && lang !== 'auto') {
                options.lang = lang;
            }

            if (getOptionChecked('pc-widget-debug')) {
                options.debug = true;
            }

            if (getOptionChecked('pc-widget-eu')) {
                options.eu = true;
            }

            return options;
        };

        const buildSnippet = (options) => {
            const optionLines = [
                `    sitekey: '${sitekey}',`,
                `    puzzleEndpoint: '${puzzleEndpoint}',`,
                `    theme: '${options.theme}',`,
                `    displayMode: '${options.displayMode}',`,
                `    startMode: '${options.startMode}',`
            ];

            if (options.lang && options.lang !== 'auto') {
                optionLines.push(`    lang: '${options.lang}',`);
            }

            if (options.debug) {
                optionLines.push('    debug: true,');
            }

            if (options.eu) {
                optionLines.push('    eu: true,');
            }

            return [
                `<script defer src="${scriptUrl}"><\\/script>`,
                `<div id="${snippetElementId}"></div>`,
                '<script>',
                `  const widget = privateCaptcha.render(document.getElementById('${snippetElementId}'), {`,
                ...optionLines,
                '  });',
                '<\\/script>'
            ].join('\n');
        };

        const toggleTrigger = (displayMode) => {
            const trigger = document.getElementById(triggerButtonId);
            if (!trigger) {
                return;
            }

            if (triggerModes.has(displayMode)) {
                trigger.classList.remove('hidden');
            } else {
                trigger.classList.add('hidden');
            }
        };

        const updateCodeSnippet = (options) => {
            const codeElement = document.getElementById(codeElementId);
            if (!codeElement) {
                return;
            }

            codeElement.textContent = buildSnippet(options);
        };

        const renderWidget = (options) => {
            const host = document.getElementById(widgetPreviewId);
            if (!host || !window.privateCaptcha || typeof window.privateCaptcha.render !== 'function') {
                return;
            }

            host.innerHTML = '';
            const widgetElement = document.createElement('div');
            widgetElement.id = snippetElementId;
            host.appendChild(widgetElement);
            currentWidget = window.privateCaptcha.render(widgetElement, options);
            toggleTrigger(options.displayMode);
        };

        const updatePreview = () => {
            latestOptions = buildOptions();
            updateCodeSnippet(latestOptions);
            renderWidget(latestOptions);
        };

        const waitForWidget = () => {
            if (window.privateCaptcha && typeof window.privateCaptcha.render === 'function') {
                pollAttempts = 0;
                if (!latestOptions) {
                    latestOptions = buildOptions();
                    updateCodeSnippet(latestOptions);
                }
                renderWidget(latestOptions);
                return;
            }

            pollAttempts += 1;
            if (pollAttempts >= maxPollAttempts) {
                return;
            }

            setTimeout(waitForWidget, pollIntervalMs);
        };

        const handleCopy = () => {
            const codeElement = document.getElementById(codeElementId);
            const copyButton = document.getElementById(copyButtonId);
            if (!codeElement || !copyButton || !navigator.clipboard) {
                return;
            }

            const originalText = copyButton.textContent;
            navigator.clipboard.writeText(codeElement.textContent || '').then(() => {
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 1500);
            });
        };

        const handleTriggerClick = () => {
            if (currentWidget && typeof currentWidget.execute === 'function') {
                currentWidget.execute();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById(customizerId);
            if (!root) {
                return;
            }

            root.querySelectorAll('[data-widget-option]').forEach((input) => {
                input.addEventListener('change', updatePreview);
            });

            const copyButton = document.getElementById(copyButtonId);
            if (copyButton) {
                copyButton.addEventListener('click', handleCopy);
            }

            const trigger = document.getElementById(triggerButtonId);
            if (trigger) {
                trigger.addEventListener('click', handleTriggerClick);
            }

            updatePreview();
            waitForWidget();
        });
    })();
</script>
